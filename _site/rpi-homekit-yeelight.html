<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="baidu-site-verification" content="x4U8lzh1X1" /><title>用树莓派实现 HomeKit 控制台灯 - 游戏暂停</title><link href="https://fonts.googleapis.com/css?family=Lato:900|Work+Sans" rel="stylesheet"><link rel="stylesheet" href="/iewaij.github.io/css/main.css"><title>用树莓派实现 HomeKit 控制台灯 - 游戏暂停</title><meta property="og:title" content="用树莓派实现 HomeKit 控制台灯" /><meta name="description" content="" /><meta property="og:description" content="" /><link rel="canonical" href="http://localhost:4000/iewaij.github.io/rpi-homekit-yeelight.html" /><meta property="og:url" content="http://localhost:4000/iewaij.github.io/rpi-homekit-yeelight.html" /><meta property="og:site_name" content="游戏暂停" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-01-06T00:08:00+08:00" /><script type="application/ld+json"> {"@context": "http://schema.org", "@type": "BlogPosting", "headline": "用树莓派实现 HomeKit 控制台灯", "datePublished": "2017-01-06T00:08:00+08:00", "description": "", "url": "http://localhost:4000/iewaij.github.io/rpi-homekit-yeelight.html"}</script><script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><script type="text/javascript"> $(document).ready(function(){ $("code").map(function(){ match = /^\$(.*)\$$/.exec($(this).html()); if (match){ //$(this).after("<span class=mathjax_inline>" + match + "</span>"); //$(this).hide(); $(this).replaceWith("<span class=hpl_mathjax_inline>" + $(this).html() + "</span>"); MathJax.Hub.Queue(["Typeset",MathJax.Hub,$(this).get(0)]); } }); });</script></head><body style="background-color: rgb(255, 255, 255)"><script src="/iewaij.github.io/js/theme.min.js"></script><header> <a href="/iewaij.github.io/"><div class="home"></div></a></header><h1 class="post-headline">用树莓派实现 HomeKit 控制台灯</h1><div class="meta"><span>January 06, 2017</span></div><ul id="markdown-toc"><li><a href="#配置树莓派" id="markdown-toc-配置树莓派">配置树莓派</a></li><li><a href="#更换国内镜像源" id="markdown-toc-更换国内镜像源">更换国内镜像源</a></li><li><a href="#安装-nodejs-及相关依赖" id="markdown-toc-安装-nodejs-及相关依赖">安装 Node.js 及相关依赖</a></li><li><a href="#安装-homebridge-及相关依赖" id="markdown-toc-安装-homebridge-及相关依赖">安装 homebridge 及相关依赖</a></li><li><a href="#安装-homebridge-yeelight" id="markdown-toc-安装-homebridge-yeelight">安装 homebridge-yeelight</a></li><li><a href="#开机启动" id="markdown-toc-开机启动">开机启动</a></li><li><a href="#参考资料" id="markdown-toc-参考资料">参考资料</a></li></ul><p>在看到少数派上的 <a href="http://sspai.com/36617">借助树莓派与 HomeBridge ，将 YeeLight 彩光灯接入 Apple HomeKit</a> 一文后, 非常心动. 在暑假的时候关注过一阵子 yeelight, 那时实现的功能非常有限还不支持 IFTTT 就作罢没有买, 但到了12月后, yeelight 既有 IFTTT 又能玩 homekit, 于是立马下单了树莓派 3 和 yeelight.</p><p>树莓派可以理解为一台微型电脑 (开发板), 运行的是树莓派定制的 Rapbian, 虽然树莓派并不是性能最强也不是最有性价比的开发板, 但它的社区支持是最友好的 (毕竟面向的人群还包括儿童), 它出的杂志 MagPi 极度令人沉迷 (甚至能让我回忆起从前看大众软件的时光), 官方的教程和文档对新手非常友好 (只需要一点点英语基础就够), 作为对比让我们斜眼一下 <a href="https://developer.qualcomm.com/hardware/dragonboard-410c/tutorial-videos">DragonBoard 410c</a>, 任何出现的问题只要 Google 一下 Raspberry Pi + 关键词都能找到, 其配套的硬件软件也很出色, 例如 sense hat 可以直接配合自带的 sense hat emulator. 因此非常推荐任何对编程感兴趣的人入手.</p><p>本文用到的硬件如下:</p><ol><li>宜家 E27 螺孔台灯 RMB 99</li><li>yeelight 彩光版 RMB 89</li><li>树莓派 3 Model B (同时配了外壳和散热片) RMB 206</li><li>预先烧录好 NOOBS 的 Micro SD 卡</li><li>网线</li><li>有线鼠标</li><li>戴尔显示器</li><li>Macbook Pro</li><li>iPhone</li></ol><h2 id="配置树莓派">配置树莓派</h2><p>参考官方指南 <a href="https://www.raspberrypi.org/learning/software-guide/">Raspberry Pi Software Guide</a> 烧录 Micro SD 卡. 把下载好的 <a href="https://www.raspberrypi.org/downloads/noobs/">NOOBS for Raspberry Pi</a> 解压缩然后拷到 SD 卡上. 当然, 也可以直接烧录 Raspbian 到 SD 卡, 这样就不用忍受 NOOBS 安装的漫长时间, 直接插卡就能开机.</p><p>插入有线鼠标 (带 USB 发射埠的无线鼠标也可以, 凑活用就好, 之后可以在 Macbook 上使用 SSH 操作), Micro SD 卡, HDMI 线, 网线, Micro USB 电源, 然后就可以安装 Raspbian, 安装完毕后就能进入系统.</p><p>进入系统后, 点击左上角 Preferences - Raspberry Pi Configuration, 打开 SSH 和 VNC. 建议在这里顺便更改用户密码.</p><p>这时候就可以切回 Macbook, 打开终端 (我使用的是 iTerm2), 输入代码 <code class="highlighter-rouge">ssh pi@raspberrypi.local</code> 然后输入树莓派的密码, 连接树莓派.</p><p><img src="http://ww2.sinaimg.cn/large/006tNc79gw1fbg76r9rl7j30oa0g1mzm.jpg" alt="" /></p><p>更具体的操作方法, 请参考官方帮助页面 <a href="https://www.raspberrypi.org/learning/software-guide/">Raspberry Pi Software Guide</a>.</p><h2 id="更换国内镜像源">更换国内镜像源</h2><p>由于国内访问树莓派服务器的不便, 因此需要更换为国内镜像, 这里我将 sources 的镜像更换为速度更快的阿里云, archive.raspberrypi.org 的镜像只找到中科大的, 因此使用了中科大的镜像.</p><div class="highlighter-rouge"><pre class="highlight"><code>sudo nano /etc/apt/sources.list
# 用 # 注释掉原有的 source, 输入阿里云镜像.
deb http://mirrors.aliyun.com/raspbian/raspbian/ jessie main non-free contrib
deb-src http://mirrors.aliyun.com/raspbian/raspbian/ jessie main non-free contrib
</code></pre></div><p><img src="http://ww3.sinaimg.cn/large/006tNc79gw1fbg76t6uh7j30oa0g142p.jpg" alt="" /></p><p>更换中科大镜像的方法一样, 但文件位置及名字不同.</p><div class="highlighter-rouge"><pre class="highlight"><code>sudo nano /etc/apt/sources.list.d/raspi.list
# 注释掉原来的, 输入中科大镜像
deb http://mirrors.ustc.edu.cn/archive.raspberrypi.org/debian/ jessie main ui
</code></pre></div><p><img src="http://ww4.sinaimg.cn/large/006tNc79gw1fbg76rmtg6j30oa0g1jtv.jpg" alt="" /></p><p>更换好源后, 输入以下代码就可以不用忍受龟速更新系统了.</p><div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get update
sudo apt-get upgrade
</code></pre></div><h2 id="安装-nodejs-及相关依赖">安装 Node.js 及相关依赖</h2><p>Homebridge 是一个用 node.js 开发的 HomeKit 服务器, 因此需要参考 <a href="https://github.com/nfarina/homebridge/wiki/Running-HomeBridge-on-a-Raspberry-Pi">Running HomeBridge on a Raspberry Pi</a> 在树莓派上先安装 node.js, 由于国内网络问题, 仍然需要更换镜像.</p><div class="highlighter-rouge"><pre class="highlight"><code>curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
# 更换为国内源
sudo nano /etc/apt/sources.list.d/nodesource.list
# 输入清华大学镜像
deb http://mirrors.tuna.tsinghua.edu.cn/nodesource/deb/ jessie main
deb-src http://mirrors.tuna.tsinghua.edu.cn/nodesource/deb/ jessie main
</code></pre></div><p>这时候就可以安装 node.js 以及其相关依赖了.</p><div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get install -y nodejs
sudo apt-get install libavahi-compat-libdnssd-dev
</code></pre></div><h2 id="安装-homebridge-及相关依赖">安装 homebridge 及相关依赖</h2><p>Homebridge 属于 node.js 下的模块之一, 这时候需要用到 npm 安装, npm 的速度也是很令人着急, 但好在 npm 可以使用代理, 这里我们使用淘宝镜像下载 homebridge. 本步骤比较繁琐, 依旧参考 <a href="https://github.com/nfarina/homebridge/wiki/Running-HomeBridge-on-a-Raspberry-Pi">Running HomeBridge on a Raspberry Pi</a>.</p><div class="highlighter-rouge"><pre class="highlight"><code># 在命令后添加 --registry=http://r.cnpmjs.org 使用国内 npm 镜像代理
sudo npm install -g --unsafe-perm homebridge hap-nodejs node-gyp --registry=http://r.cnpmjs.org
cd /usr/lib/node_modules/homebridge/
sudo npm install --unsafe-perm bignum --registry=http://r.cnpmjs.org
cd /usr/lib/node_modules/hap-nodejs/node_modules/mdns
sudo node-gyp BUILDTYPE=Release rebuild
</code></pre></div><p>这时候可以输入 <code class="highlighter-rouge">homebridge</code> 测试能否正常运行 homebridge, 如果一切顺利的话, 能看到 homebridge 一直运行且没有报错, 打开手机的家庭 app 添加配件就能看到 homebridge.</p><h2 id="安装-homebridge-yeelight">安装 homebridge-yeelight</h2><p>记得打开 yeelight 的极客模式, 最新版本 (0.0.1.4) 的 <a href="https://www.npmjs.com/package/homebridge-yeelight">homebridge-yeelight</a> 已经不需要更改 config.json 了, 因此直接输入以下代码就完成了配置, 能在手机里添加台灯了.</p><div class="highlighter-rouge"><pre class="highlight"><code>sudo npm install -g homebridge-yeelight --registry=http://r.cnpmjs.org
homebridge
</code></pre></div><h2 id="开机启动">开机启动</h2><p><a href="https://github.com/nfarina/homebridge/wiki/Running-HomeBridge-on-a-Raspberry-Pi">Running HomeBridge on a Raspberry Pi</a> 上给出的添加启动项实在是太繁琐了, 我甚至因为这一步没弄明白重新刷了次机, 还顺便搞懂了.bashrc 和 rc.local 有什么区别. 事实上, 树莓派文档 <a href="https://www.raspberrypi.org/documentation/linux/usage/cron.md">Scheduling tasks with Cron</a> 给出的方法是最简单且方便以后配置别的程序的.</p><div class="highlighter-rouge"><pre class="highlight"><code># 先安装 cron
sudo apt-get install gnome-schedule
</code></pre></div><p>然后配置 cron.</p><div class="highlighter-rouge"><pre class="highlight"><code>crontab -e
</code></pre></div><p>在最下方添加 <code class="highlighter-rouge">@reboot homebridge &amp;</code> 即可完成开机启动 homebridge 的配置. 再多嘴一句, cron 这个命令非常好用, 在 system tools 里有 GUI 界面, 还能让树莓派完成每周日运行 <code class="highlighter-rouge">sudo apt-get update sudo apt-get update</code> 这样的定时任务.</p><h2 id="参考资料">参考资料</h2><p><a href="https://www.raspberrypi.org/documentation/linux/usage/cron.md">Scheduling tasks with Cron - Raspberry Pi Documentation (树莓派官方的资料真的非常友好)</a></p><p><a href="https://www.raspberrypi.org/documentation/">Raspberry Pi Documentation</a></p><p><a href="http://sspai.com/36617">借助树莓派与HomeBridge，将 YeeLight 彩光灯接入 Apple HomeKit - 少数派</a></p><p><a href="http://bbs.xiaomi.cn/t-13198850">小米网关接入Homekit完整教程，声控家中设备! - 小米社区官方论坛</a></p><br /><br /><div id="lv-container" data-id="city" data-uid="MTAyMC8yNjc4NC8zMzcy"><script type="text/javascript"> (function(d, s) { var j, e = d.getElementsByTagName(s)[0]; if (typeof LivereTower === 'function') { return; } j = d.createElement(s); j.src = 'https://cdn-city.livere.com/js/embed.dist.js'; j.async = true; e.parentNode.insertBefore(j, e); })(document, 'script');</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div><footer><div class="links"> <a href="/iewaij.github.io/about/">About</a> <a href="/iewaij.github.io/contact/">Contact</a> <a href="/iewaij.github.io/feed.xml">RSS</a> <a onclick="theme()">Change Theme</a></div></footer><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-92264874-1', 'auto'); ga('send', 'pageview');</script></body></html>
